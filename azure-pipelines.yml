variables:
  DOCKER_CI_BUILD_TAG: monorepo.$(Build.BuildID)
  CORE_IMAGE_BUILD: augurproject/augur-core:$(DOCKER_CI_BUILD_TAG)
  CORE_IMAGE_LATEST: augurproject/augur-core:monorepo
  PRIMARY_NODE_VERSION: 10.16.x
  GETH_VERSION: v1.9.9
  SOLC_VERSION: v0.5.15
  SOLC_MD5: 884dbc8c8ed01cc34799a6ffab11bc3a
  VM_IMAGE: 'ubuntu-18.04'
  YARN_REGISTRY: https://pkgs.dev.azure.com/augurproject/_packaging/npmPackages/npm/registry/
  System.debug: true

trigger:
  batch: false
  branches:
    include:
      - dev
      - v2
      - release/*
      - azure/*
      - refs/tags/*

jobs:
  - job: PreFlightCheck
    displayName: 'Pre-Flight Check'
    pool:
      vmImage: $(VM_IMAGE)
    steps:
      - checkout: self
      - bash: |
          set -euo pipefail
          echo "Build Source Branch: $(Build.SourceBranchName)"
          echo "commit message: $(Build.SourceVersionMessage)"
          if [[ "$(Build.SourceBranchName)" == "dev" || "$(Build.SourceBranchName)" == "v2" ]]; then
            GIT_COMMAND='git log -m -1 --name-only --pretty="format:" $(Build.SourceVersion)'
          else
            GIT_COMMAND='git diff --name-only $(System.PullRequest.TargetBranch)..HEAD'
          fi
          echo "running git command: $GIT_COMMAND"
          for f in $(eval "$GIT_COMMAND");
            do
              echo "$f"
              if [[ $f == packages/* ]] && [[ ! $f =~ .*packages/augur-ui/* ]] && [[ ! $f =~ .*packages/augur-artifacts/* ]]
              then
                echo "found a non-ui change: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_TEST;isOutput=true]true"
              fi
              if [[ $f =~ .*augur-core/.* ]]
              then
                echo "found a core change: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_CORE;isOutput=true]true"
              fi
              if [[ $f =~ .*augur-artifacts/src/contracts.json ]]
              then
                echo "found an artifacts change: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_POP_GETH;isOutput=true]true"
              fi
              if [[ $f =~ .*augur-tools/docker-builder/* ]]
              then
                echo "found a docker-builder change: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_POP_GETH;isOutput=true]true"
              fi
              if [[ $f =~ .*augur-tools/ethereum-nodes/geth-poa/.* ]]
              then
                echo "found a change in geth-poa: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_GETH_POA;isOutput=true]true"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_POP_GETH;isOutput=true]true"
              fi
              if [[ $f =~ .*augur-ui.* ]]
              then
                echo "found a ui change: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_UI;isOutput=true]true"
              fi
              if [[ $f =~ .*augur-sdk.* ]]
              then
                echo "found a sdk change: $f"
                echo "##vso[task.setvariable variable=JOB_TRIGGER_SDK;isOutput=true]true"
              fi
            done
        displayName: check git for changes
        name: setVars
  - job: TestingNPMStuff
    dependsOn:
      - PreFlightCheck
    pool: 'Default'
    steps:
      - template: .azure-templates/node-setup.yml
      - script: echo "registry = https://registry.npmjs.org/" > .npmrc
      - task: npmAuthenticate@0
        inputs:
          workingFile: .npmrc
          customEndpoint: npmjs-augur-integration

      - script: cat .npmrc
      - script: npm access ls-packages
